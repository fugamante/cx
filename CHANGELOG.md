# Changelog

All notable changes to this project are documented in this file.

## [Unreleased]

### Added
- `rust/cxrs/src/modules/config.rs`:
  - centralized `AppConfig` startup snapshot for runtime env/default resolution
  - centralized app constants (`APP_NAME`, `APP_DESC`, `APP_VERSION`)
  - centralized defaults (`12000` chars, `300` lines, `50` run window, `200` optimize window, `20` quarantine list)
- Rust module layout for canonical runtime pieces:
  - `src/types.rs` (`b8aceec`)
  - `src/paths.rs`, `src/state.rs` (`7334426`)
  - `src/logs.rs` (`557cc81`)
  - `src/util.rs` (`08db4db`)
  - `src/schema.rs` (`c1072e6`)
  - `src/capture.rs` (`dc466d4`)
  - `src/tasks.rs` (`67be0c5`)
  - `src/taskrun.rs` (`b9cdf8b`)
  - `src/llm.rs` (`abbb748`)
  - `src/quarantine.rs` (`3390c14`)
  - `src/policy.rs` (`16dc692`)
  - `src/runtime.rs` (`41ad1c4`)
  - `src/execmeta.rs`, `src/runlog.rs` (`1380d5c`)
  - `src/optimize.rs`
  - `src/prompting.rs`
  - `src/routing.rs`
  - `src/diagnostics.rs`
  - `src/analytics.rs`
  - `src/logview.rs`
  - `src/agentcmds.rs`
  - `src/runtime_controls.rs`
  - `src/introspect.rs`
  - `src/doctor.rs`
  - `src/schema_ops.rs`
  - `src/settings_cmds.rs`
  - `src/structured_cmds.rs`
  - `src/task_cmds.rs`
  - `src/bench_parity.rs`
  - `src/exec_core.rs`
  - `src/compat_cmd.rs`
  - `src/cmdctx.rs`
  - `src/execution.rs`
  - `src/native_cmd.rs`
  - `src/process.rs` (timeout-aware external process runner)
  - `src/optimize_rules.rs` (optimize anomaly/recommendation rules)
- Timeout telemetry fields in run logs:
  - `timed_out`
  - `timeout_secs`
  - `command_label`
- Reliability integration test suite:
  - `rust/cxrs/tests/reliability_integration.rs`
  - timeout-failure injection coverage with timeout metadata assertions
  - schema-failure injection coverage with quarantine/log assertions
  - replay determinism loop coverage (`replay` repeated runs)
  - ollama timeout/failure-path coverage with backend + timeout log assertions
  - rtk capture failure fallback coverage (`capture_provider=native`, `rtk_used=false`)
  - `fix-run` policy-block invariant coverage (`policy_blocked=true` + reason present)
  - expanded failure-matrix coverage:
    - missing schema file in partial registry scenarios
    - corrupted quarantine record handling (`quarantine show`)
    - unwritable `.codex/quarantine` error surfacing during schema failure handling
    - unwritable `.codex/cxlogs` resilience (command execution remains functional)
    - timeout override end-to-end coverage for `CX_TIMEOUT_LLM_SECS`, `CX_TIMEOUT_GIT_SECS`, and `CX_TIMEOUT_SHELL_SECS`
  - expanded Ollama backend coverage:
    - unset/set model transition enforcement with persisted state verification
    - malformed schema-output handling under Ollama with quarantine/log assertions
    - schema-command enforcement under `CX_MODE=lean` (schema remains enforced/validated)

### Changed
- Expanded `cxparity` overlap coverage and invariants:
  - widened shared-command matrix from a minimal subset to include `cx`, `cxj`, `cxol`, `cxcopy`, `cxnext`, `cxdiffsum_staged`, `cxcommitmsg`, and `cxcommitjson`
  - added deterministic local parity mocks (`codex` + clipboard backend) so parity runs are stable and backend-independent
  - parity temp repos now receive schema registry fixtures, enabling structured-command checks without ambient machine state
  - tightened parity log invariant checks via required-field validation (`schema_enforced`, `duration_ms` included)
- Replaced string-parsed timeout telemetry with structured timeout propagation:
  - `rust/cxrs/src/modules/process.rs` now emits `ProcessError::Timeout { label, timeout_secs }`
  - `rust/cxrs/src/modules/llm.rs` preserves timeout metadata in `LlmRunError`
  - `rust/cxrs/src/modules/execution.rs` logs timeout fields from structured metadata (no error-text parsing dependency)
- Expanded CI platform coverage in `.github/workflows/cxrs-compat.yml`:
  - `cxrs-compat` now runs on both `ubuntu-latest` and `macos-latest`
- Hardened task execution overrides in `rust/cxrs/src/modules/taskrun.rs`:
  - replaced in-process environment mutation for `--mode`/`--backend` overrides with subprocess-based execution for recognized command objectives
  - eliminated unsafe global env toggling in task-run paths while preserving command routing behavior
- Improved task objective tokenization in `rust/cxrs/src/modules/taskrun.rs`:
  - command-like objectives now parse with shell-quoted semantics via `shell-words`
  - falls back to whitespace split only if shell parsing fails
- Refactored command wrappers (`cx`, `cxj`, `cxo`, `cxol`) in `rust/cxrs/src/modules/agentcmds.rs` to use shared `execute_llm_command(command, LlmMode, run_task)` flow while preserving output behavior.
- Replaced repeated env/default lookups across core modules with `AppConfig` reads (`app`, `capture`, `runtime`, `runlog`, `execution`, `structured_cmds`, `bench_parity`, `diagnostics`, `introspect`, `logview`, `policy`, `tasks`, `schema`, `compat_cmd`, `native_cmd`).
- Split monolithic `main.rs` into module-based architecture with `app.rs` as command orchestrator (`98f49d0`).
- Hardened execution core contracts:
  - schema retry/quarantine behavior
  - stable execution log contract
  - CI validation path (`2600d21`).
- Routed `logs` command through dedicated logs module and normalized shared helpers (`08db4db`).
- Hardened log loading/migration error paths with clearer diagnostics (`4106410`).
- Extracted policy and state-path/task-id helpers from `app.rs` into dedicated modules (`16dc692`).
- Extracted LLM backend/model runtime resolution from `app.rs` (`41ad1c4`).
- Reworked run logging call sites to use a structured input object instead of long argument lists (`42c181f`).
- Centralized execution log row validation in `src/logs.rs` (`c88978b`).
- Reused shared UTC timestamp helper across modules (`6a288a8`).
- Extracted optimize analytics (`parse_optimize_args`, `optimize_report`, `print_optimize`) from `app.rs` to `src/optimize.rs`.
- Extracted prompt engineering commands (`roles`, `prompt`, `fanout`, `promptlint`) from `app.rs` to `src/prompting.rs`.
- Extracted routing/provenance commands and helpers (`where`, `routes`, bash function resolution) from `app.rs` to `src/routing.rs`.
- Extracted diagnostics helpers/command (`diag`, last-appended log helpers) from `app.rs` to `src/diagnostics.rs`.
- Extracted analytics/reporting commands (`profile`, `metrics`, `alert`, `worklog`, `trace`) from `app.rs` to `src/analytics.rs`.
- Extracted log presentation commands (`budget`, `log-tail`) from `app.rs` to `src/logview.rs`.
- Extracted command wrappers (`cx`, `cxj`, `cxo`, `cxol`, `cxcopy`, `fix`) from `app.rs` to `src/agentcmds.rs`.
- Extracted runtime toggle/status commands (`log-on/off`, `alert-*`, `rtk-status`) from `app.rs` to `src/runtime_controls.rs`.
- Extracted version/core introspection output builders from `app.rs` to `src/introspect.rs`.
- Extracted non-interactive doctor/health checks from `app.rs` to `src/doctor.rs` and routed compat/native command paths through it.
- Extracted `schema list` and `ci validate` command handlers into `src/schema_ops.rs`.
- Extracted state and LLM preference command handlers (`state show/get/set`, `llm *`) into `src/settings_cmds.rs`.
- Extracted structured command family (`next`, `fix-run`, `diffsum*`, `commitjson`, `commitmsg`, `replay`) into `src/structured_cmds.rs`.
- Extracted task command dispatcher (`task add/list/show/claim/complete/fail/fanout/run/run-all`) into `src/task_cmds.rs`.
- Extracted `bench` and `parity` command flows into `src/bench_parity.rs`.
- Extracted execution core (`run_llm_plain`, `run_llm_jsonl`, `execute_task`) into `src/exec_core.rs`.
- Extracted `cx-compat` command dispatcher into `src/compat_cmd.rs`.
- Introduced shared command context type in `src/cmdctx.rs` for handler-style module entrypoints.
- Renamed execution core module path from `exec_core` to `execution` and rewired call sites.
- Migrated `task_cmds` and `compat_cmd` to `handler(ctx, args, deps)` style entrypoints.
- Reorganized source layout: moved orchestrator to `src/app/mod.rs` and consolidated domain modules under `src/modules/`.
- Extracted native command dispatcher (`run` match logic) into `src/native_cmd.rs` with `handler(ctx, args, deps)`.
- Extracted command-name classifiers (`is_native_name`, `is_compat_name`) into `src/command_names.rs`.
- Applied rustfmt normalization after module extraction (`7f018ec`).
- Continued refactor pass to remove remaining quality-gate violations across Rust modules:
  - decomposed large handlers in `bench_parity`, `structured_fixrun`, `prompting`, `doctor`, `taskrun`, `logs_read`, `logs_migrate`, `runlog`, and `structured_replay`
  - introduced `src/modules/bench_parity_support.rs` and rewired `bench_parity` to use helper-only support paths
  - simplified command-name and analytics/reporting helpers to reduce function complexity while preserving behavior
  - retained deterministic schema handling and run-log contract while reducing function size and duplication
- Added timeout-aware execution for external command invocations and routed core command paths through shared timeout helpers.
  - New env: `CX_CMD_TIMEOUT_SECS` (default `120`)
- Added optional timeout overrides by command class:
  - `CX_TIMEOUT_LLM_SECS`
  - `CX_TIMEOUT_GIT_SECS`
  - `CX_TIMEOUT_SHELL_SECS`
- Extended `cx optimize` scoreboard/anomaly/recommendation output with timeout frequency and top timeout labels.
- Updated `cxcopy` clipboard handling to auto-try `pbcopy`, `wl-copy`, and `xclip` with timeout protection.
- Added quality-gate baseline control to prevent silent growth of raw `eprintln!` usage:
  - `tools/quality_gate.py --max-raw-eprintln <N>`
  - wired into `.github/workflows/cxrs-compat.yml`.
- Centralized stderr diagnostics behind `cx_eprintln!` and converted Rust modules away from direct `eprintln!` callsites.
- Tightened quality gate raw-stderr detection to true raw macro calls (ignores wrapper macro names) and lowered CI baseline to `0`.
- `replay` command now validates output against the quarantine-stored schema (not just JSON parse), and quarantines/logs invalid replay responses.
- CI now runs dedicated reliability suite job step (`cargo test --test reliability_integration`).

### Fixed
- Reduced fragile parsing and error suppression in run-log and schema paths via explicit error propagation and quarantining (`2600d21`, `4106410`, `3390c14`).
- Improved deterministic schema-path reliability by consolidating schema helpers and validators (`c1072e6`, `1380d5c`).

### Notes
- Refactor focus is Rust-first canonicalization: Bash remains compatibility/bootstrap.
- Current work preserved CLI behavior while reducing monolithic surface area and improving testability.
- Latest refactor state passes:
  - `cargo test -q -- --test-threads=1`
  - `tools/quality_gate.py --src src --max-file-lines 400 --max-fn-lines 50 --allow-fn execute_task`
