#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

if [[ $# -lt 1 ]]; then
  echo "Usage: cx <subcommand> [args...]" >&2
  echo "Example: cx cxversion" >&2
  exit 2
fi

subcommand="$1"

# Prefer Rust runtime when present; fallback to Bash function layer.
CXRS_WRAPPER="$REPO_ROOT/rust/cxrs/bin/cxrs"
CXRS_MANIFEST="$REPO_ROOT/rust/cxrs/Cargo.toml"
CXRS_BIN_RELEASE="$REPO_ROOT/rust/cxrs/target/release/cxrs"
CXRS_BIN_DEBUG="$REPO_ROOT/rust/cxrs/target/debug/cxrs"

_cx_needs_build() {
  local bin="$1"
  [[ ! -x "$bin" ]] && return 0
  [[ "$CXRS_MANIFEST" -nt "$bin" ]] && return 0
  [[ "$REPO_ROOT/rust/cxrs/Cargo.lock" -nt "$bin" ]] && return 0
  if find "$REPO_ROOT/rust/cxrs/src" -type f -name '*.rs' -newer "$bin" -print -quit 2>/dev/null \
    | grep -q .; then
    return 0
  fi
  return 1
}

_cx_run_rust() {
  local cxrs_bin=""

  if [[ -x "$CXRS_BIN_RELEASE" ]]; then
    if _cx_needs_build "$CXRS_BIN_RELEASE" && command -v cargo >/dev/null 2>&1; then
      cargo build --quiet --manifest-path "$CXRS_MANIFEST" --release 1>&2
    fi
    cxrs_bin="$CXRS_BIN_RELEASE"
  elif [[ -x "$CXRS_BIN_DEBUG" ]]; then
    if _cx_needs_build "$CXRS_BIN_DEBUG" && command -v cargo >/dev/null 2>&1; then
      cargo build --quiet --manifest-path "$CXRS_MANIFEST" 1>&2
    fi
    cxrs_bin="$CXRS_BIN_DEBUG"
  elif [[ -f "$CXRS_MANIFEST" ]] && command -v cargo >/dev/null 2>&1; then
    # Build once, then execute the compiled binary. Avoid `cargo run` to prevent compile warnings
    # and build logs from polluting normal CLI output.
    cargo build --quiet --manifest-path "$CXRS_MANIFEST" --release 1>&2
    if [[ -x "$CXRS_BIN_RELEASE" ]]; then
      cxrs_bin="$CXRS_BIN_RELEASE"
    fi
  elif [[ -x "$CXRS_WRAPPER" ]]; then
    cxrs_bin="$CXRS_WRAPPER"
  fi

  if [[ -z "$cxrs_bin" ]]; then
    return 127
  fi

  CX_REPO_ROOT="$REPO_ROOT" CX_BIN_CX="$REPO_ROOT/bin/cx" CX_SOURCE_LOCATION="repo:$REPO_ROOT/cx.sh" CX_EXECUTION_PATH="rust:bin/cx" \
    "$cxrs_bin" "$@"
}

if _cx_run_rust supports "$subcommand" >/dev/null 2>&1; then
  if [[ "$subcommand" == cx* ]]; then
    _cx_run_rust cx-compat "$@"
  else
    _cx_run_rust "$@"
  fi
  exit $?
fi

# shellcheck disable=SC1091
source "$REPO_ROOT/cx.sh"
fn="$subcommand"
shift

if ! declare -F "$fn" >/dev/null 2>&1; then
  if [[ -f "$CXRS_MANIFEST" ]] || [[ -x "$CXRS_WRAPPER" ]]; then
    echo "cx: unsupported command '$fn' (not supported by cxrs or bash compatibility layer)" >&2
  else
    echo "cx: unknown function '$fn' (rust runtime unavailable and bash function missing)" >&2
  fi
  exit 2
fi

export CX_EXECUTION_PATH="${CX_EXECUTION_PATH:-bash:bin/cx-fallback}"
"$fn" "$@"
