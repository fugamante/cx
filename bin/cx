#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Prefer Rust runtime when present; keep Bash function fallback for compatibility.
CXRS_WRAPPER="$REPO_ROOT/rust/cxrs/bin/cxrs"
CXRS_MANIFEST="$REPO_ROOT/rust/cxrs/Cargo.toml"
if [[ -f "$CXRS_MANIFEST" ]] && command -v cargo >/dev/null 2>&1; then
  exec cargo run --quiet --manifest-path "$CXRS_MANIFEST" -- cx-compat "$@"
fi
if [[ -x "$CXRS_WRAPPER" ]]; then
  exec "$CXRS_WRAPPER" cx-compat "$@"
fi

# shellcheck disable=SC1091
source "$REPO_ROOT/cx.sh"

if [[ $# -lt 1 ]]; then
  echo "Usage: cx <cx-function> [args...]" >&2
  echo "Example: cx cxversion" >&2
  exit 2
fi

fn="$1"
shift

if ! declare -F "$fn" >/dev/null 2>&1; then
  echo "cx: unknown function '$fn'" >&2
  exit 2
fi

"$fn" "$@"
